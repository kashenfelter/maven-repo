<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--
Copyright (c) Patrick Huber / stackmagic@gmail.com

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!--
Ideas for more:
* show an extra line at the bottom of the panel with a history of past builds, just the number and an icon or red/green color => http://travis-ci.org/:owner_name/:name/builds.json
* read the username from the url (param or maybe domain name)
* display in progress builds with a spinner icon and grey background for the panel
* order panels: failed on top, the build in progress then ok - each group sorted by newest on top
* make it completely self-contained, load once, let it run forever
* back/fwd buttons to navigate between builds, button to reset - kinda duplicates the past builds history
* use http://travis-ci.org/workers.json to check if one of my projects is currently pending a build
* support a comma separated list of usernames as in #stackmagic,twitter and display a single list containing all projects of all users
* update all the timestamp in the ui the same as the last update ts on top
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
	<head>
		<title>Travis Dashboard</title>
		<style>
			body {
				font-family: helvetica;
				font-weight: bold;
				font-size: 2em;
				background-color: #000000;
				color: #FFFFFF;
			}
			a, a:visited, a:active {
				color: #FFFFFF;
				text-decoration: none;
			}
			a:hover {
				text-decoration: underline;
			}
			img {
				margin-top: 0.25em;
				margin-right: 0.25em;
				vertical-align: center;
			}
			#credit {
				font-size: 0.5em;
				text-align: right;
				margin-right: 0.5%;
				margin-bottom: 0.5%;
			}
			#result > div {
				width: 99%;
				display: inline-block;
				border: 1px solid #FFFFFF;
				padding: 5px;
				margin-bottom: 0.5%;
			}
			#result > div.ok {
				background-color: #00AA00;
			}
			#result > div.fail {
				background-color: #AA0000;
			}
			#result > div.unknown {
				background-color: #666666;
			}
			#result > div > div {
				white-space: nowrap;
				overflow: hidden;
				display: inline-block;
				padding: 0;
			}
			#result > div > div:nth-child(odd) {
				width: 64%;
				text-align: left;
			}
			#result > div > div:nth-child(even) {
				width: 35%;
				text-align: right;
			}
		</style>
		<script type="text/javascript" src="https://raw.github.com/zachleat/Humane-Dates/1b557e21c8ec0a8889af0f78d1ee1eba33a2a259/humane.js"></script>
		<script type="text/javascript">
			// read the response and update the dashboard
			function parseResponse(json) {
				if (json.length < 1) {
					alert("Response contains no data, maybe that user does not exist?")
					return
				}

				result = document.getElementById("result")
				while (result.childNodes.length > 0) {
					result.removeChild(result.firstChild)
				}

				// add failed builds first
				for (i = 0; i < json.length; i++) {
					if (json[i].last_build_result != 0) {
						result.appendChild(buildPanel(json[i]))
					}
				}

				// add successfull builds below
				for (i = 0; i < json.length; i++) {
					if (json[i].last_build_result == 0) {
						result.appendChild(buildPanel(json[i]))
					}
				}

				document.getElementById("lastUpdated").lastUpdated = new Date()
			}

			function buildPanel(json) {
				panel = document.createElement("div")
				if (json.last_build_result == 0) {
					panel.setAttribute("class", "ok")
				}
				else if (json.last_build_result == null) {
					panel.setAttribute("class", "unknown")
				}
				else {
					panel.setAttribute("class", "fail")
				}
	
				repoName = document.createElement("div")
				repoNameLink = document.createElement("a")
				repoNameLink.setAttribute("href", "http://travis-ci.org/" + json.slug)
				repoNameLinkIco = document.createElement("img")
				repoNameLinkIco.setAttribute("src", "http://travis-ci.org/favicon.ico");
				repoNameLink.appendChild(repoNameLinkIco)
				repoNameLink.appendChild(document.createTextNode(json.slug))
				repoName.appendChild(repoNameLink)
				panel.appendChild(repoName)

				buildId = document.createElement("div")
				buildIdLink = document.createElement("a")
				buildIdLink.setAttribute("href", "http://travis-ci.org/" + json.slug + "/builds/" + json.last_build_id)
				buildIdLink.appendChild(document.createTextNode("#" + json.last_build_number))
				buildId.appendChild(buildIdLink)
				panel.appendChild(buildId)

				repoDesc = document.createElement("div")
				repoDescLink = document.createElement("a")
				repoDescLink.setAttribute("href", "https://github.com/" + json.slug)
				repoDescLinkIco = document.createElement("img")
				repoDescLinkIco.setAttribute("src", "https://github.com/favicon.ico")
				repoDescLink.appendChild(repoDescLinkIco)
				repoDescLink.appendChild(document.createTextNode(json.description))
				repoDesc.appendChild(repoDescLink)
				panel.appendChild(repoDesc)

				buildDone = document.createElement("div")
				buildDone.appendChild(document.createTextNode(humaneDate(json.last_build_finished_at)))
				panel.appendChild(buildDone)

				return panel
			}

			// update the dashboard
			function update() {
				user = "stackmagic"

				// try to get username from subdomain
				loc = window.location.host
				if (loc.split(".").length > 0 && loc.indexOf("localhost") < 0 && loc.indexOf("127.0.0") < 0) {
					user = loc.split(".")[0]
				}

				// try to get username from anchor in url
				loc = window.location.href
				if (user == "stackmagic" && loc.indexOf("#") > 0) {
					newUser = loc.split("#")[1]
					if (newUser.length > 0) {
						user = newUser
					}
				}

				while (document.body.getElementsByTagName("script").length > 0) {
					document.body.removeChild(document.body.getElementsByTagName("script")[0])
				}

				script = document.createElement("script")
				script.setAttribute("type", "text/javascript")
				script.setAttribute("src", "http://travis-ci.org/repositories.json?owner_name=" + user + "&amp;callback=parseResponse")
				document.body.appendChild(script)
			}

			function lastUpdated() {
				lu = document.getElementById("lastUpdated")
				lu.innerText = humaneDate(lu.lastUpdated)
			}

			function init() {
				update()
				setInterval(lastUpdated, 1000)
				setInterval(update, 30000)
			}
		</script>
	</head>
	<body id="body" onload="init()" onhashchange="update()">
		<div id="credit">
			<a href="javascript:update()">update now</a> (last updated: <span id="lastUpdated">never</span>) | 
			<a href="http://travis-ci.org">travis-ci</a> dashboard by
			<a href="https://www.twitter.com/stackmagic">@</a><a href="http://github.com/stackmagic">stackmagic</a> | 
			<a href="https://github.com/stackmagic/maven-repo#readme">README</a>
		</div>
		<div id="result">Loading...</div>
	</body>
</html>
