<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!--
Copyright (c) Patrick Huber / stackmagic@gmail.com

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
	<head>
		<meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
		<title>Travis Dashboard</title>
		<style>
			body {
				font-family: helvetica;
				font-weight: bold;
				font-size: 2em;
				background-color: #000000;
				color: #FFFFFF;
			}
			a, a:visited, a:active {
				color: #FFFFFF;
				text-decoration: none;
			}
			a:hover {
				text-decoration: underline;
			}
			img {
				margin-top: 0.25em;
				margin-right: 0.25em;
				vertical-align: center;
			}
			#credit {
				font-size: 0.5em;
				text-align: right;
				margin-right: 0.5%;
				margin-bottom: 0.5%;
			}
			#result > div {
				width: 99%;
				display: inline-block;
				border: 1px solid #FFFFFF;
				padding: 5px;
				margin-bottom: 0.5%;
			}
			#result > div.ok {
				background-color: #00AA00;
			}
			#result > div.fail {
				background-color: #AA0000;
			}
			#result > div.unknown {
				background-color: #666666;
			}
			#result > div > div {
				white-space: nowrap;
				overflow: hidden;
				display: inline-block;
				padding: 0;
			}
			#result > div > div:nth-child(odd) {
				width: 64%;
				text-align: left;
			}
			#result > div > div:nth-child(even) {
				width: 35%;
				text-align: right;
			}
		</style>
<!--
Ideas for more:
* show an extra line at the bottom of the panel with a history of past builds, just the number and an icon or red/green color => http://api.travis-ci.org/:owner_name/:name/builds.json
* read the username from the url (param or maybe domain name)
* display in progress builds with a spinner icon and grey background for the panel
* order panels: failed on top, the build in progress then ok - each group sorted by newest on top
* make it completely self-contained, load once, let it run forever
* back/fwd buttons to navigate between builds, button to reset - kinda duplicates the past builds history
* use http://travis-ci.org/workers.json to check if one of my projects is currently pending a build
* support a comma separated list of usernames as in #stackmagic,twitter and display a single list containing all projects of all users
* update all the timestamp in the ui the same as the last update ts on top
-->
		<script type="text/javascript">
/*
 * copied from: https://raw.github.com/zachleat/Humane-Dates/1b557e21c8ec0a8889af0f78d1ee1eba33a2a259/humane.js
 * because chrome refuses from loading it because 'strict MIME type checking is enabled'
 */

/*
 * Javascript Humane Dates
 * Copyright (c) 2008 Dean Landolt (deanlandolt.com)
 * Re-write by Zach Leatherman (zachleat.com)
 *
 * Adopted from the John Resig's pretty.js
 * at http://ejohn.org/blog/javascript-pretty-date
 * and henrah's proposed modification
 * at http://ejohn.org/blog/javascript-pretty-date/#comment-297458
 *
 * Licensed under the MIT license.
 */

function humaneDate(date, compareTo){

    if(!date) {
        return;
    }

    var lang = {
            ago: 'Ago',
            from: '',
            now: 'Just Now',
            minute: 'Minute',
            minutes: 'Minutes',
            hour: 'Hour',
            hours: 'Hours',
            day: 'Day',
            days: 'Days',
            week: 'Week',
            weeks: 'Weeks',
            month: 'Month',
            months: 'Months',
            year: 'Year',
            years: 'Years'
        },
        formats = [
            [60, lang.now],
            [3600, lang.minute, lang.minutes, 60], // 60 minutes, 1 minute
            [86400, lang.hour, lang.hours, 3600], // 24 hours, 1 hour
            [604800, lang.day, lang.days, 86400], // 7 days, 1 day
            [2628000, lang.week, lang.weeks, 604800], // ~1 month, 1 week
            [31536000, lang.month, lang.months, 2628000], // 1 year, ~1 month
            [Infinity, lang.year, lang.years, 31536000] // Infinity, 1 year
        ],
        isString = typeof date == 'string',
        date = isString ?
                    new Date(('' + date).replace(/-/g,"/").replace(/[TZ]/g," ")) :
                    date,
        compareTo = compareTo || new Date,
        seconds = (compareTo - date +
                        (compareTo.getTimezoneOffset() -
                            // if we received a GMT time from a string, doesn't include time zone bias
                            // if we got a date object, the time zone is built in, we need to remove it.
                            (isString ? 0 : date.getTimezoneOffset())
                        ) * 60000
                    ) / 1000,
        token;

    if(seconds < 0) {
        seconds = Math.abs(seconds);
        token = lang.from ? ' ' + lang.from : '';
    } else {
        token = lang.ago ? ' ' + lang.ago : '';
    }

    /*
     * 0 seconds && < 60 seconds        Now
     * 60 seconds                       1 Minute
     * > 60 seconds && < 60 minutes     X Minutes
     * 60 minutes                       1 Hour
     * > 60 minutes && < 24 hours       X Hours
     * 24 hours                         1 Day
     * > 24 hours && < 7 days           X Days
     * 7 days                           1 Week
     * > 7 days && < ~ 1 Month          X Weeks
     * ~ 1 Month                        1 Month
     * > ~ 1 Month && < 1 Year          X Months
     * 1 Year                           1 Year
     * > 1 Year                         X Years
     *
     * Single units are +10%. 1 Year shows first at 1 Year + 10%
     */

    function normalize(val, single)
    {
        var margin = 0.1;
        if(val >= single && val <= single * (1+margin)) {
            return single;
        }
        return val;
    }

    for(var i = 0, format = formats[0]; formats[i]; format = formats[++i]) {
        if(seconds < format[0]) {
            if(i === 0) {
                // Now
                return format[1];
            }

            var val = Math.ceil(normalize(seconds, format[3]) / (format[3]));
            return val +
                    ' ' +
                    (val != 1 ? format[2] : format[1]) +
                    (i > 0 ? token : '');
        }
    }
};

if(typeof jQuery != 'undefined') {
    jQuery.fn.humaneDates = function(options)
    {
        var settings = jQuery.extend({
            'lowercase': false
        }, options);

        return this.each(function()
        {
            var $t = jQuery(this),
                date = $t.attr('datetime') || $t.attr('title');

            date = humaneDate(date);

            if(date && settings['lowercase']) {
                date = date.toLowerCase();
            }

            if(date && $t.html() != date) {
                // don't modify the dom if we don't have to
                $t.html(date);
            }
        });
    };
}
		</script>
		<script type="text/javascript">
			// read the response and update the dashboard
			function parseResponse(json) {
				if (json.length < 1) {
					alert("Response contains no data, maybe that user does not exist?")
					return
				}

				result = document.getElementById("result")
				while (result.childNodes.length > 0) {
					result.removeChild(result.firstChild)
				}

				// add failed builds first
				for (i = 0; i < json.length; i++) {
					if (json[i].last_build_result != 0) {
						result.appendChild(buildPanel(json[i]))
					}
				}

				// add successfull builds below
				for (i = 0; i < json.length; i++) {
					if (json[i].last_build_result == 0) {
						result.appendChild(buildPanel(json[i]))
					}
				}

				document.getElementById("lastUpdated").lastUpdated = new Date()
			}

			function buildPanel(json) {
				panel = document.createElement("div")
				if (json.last_build_result == 0) {
					panel.setAttribute("class", "ok")
				}
				else if (json.last_build_result == null) {
					panel.setAttribute("class", "unknown")
				}
				else {
					panel.setAttribute("class", "fail")
				}

				repoName = document.createElement("div")
				repoNameLink = document.createElement("a")
				repoNameLink.setAttribute("href", "https://travis-ci.org/" + json.slug)
				repoNameLinkIco = document.createElement("img")
				repoNameLinkIco.setAttribute("src", "https://travis-ci.org/favicon.ico");
				repoNameLink.appendChild(repoNameLinkIco)
				repoNameLink.appendChild(document.createTextNode(json.slug))
				repoName.appendChild(repoNameLink)
				panel.appendChild(repoName)

				buildId = document.createElement("div")
				buildIdLink = document.createElement("a")
				buildIdLink.setAttribute("href", "https://travis-ci.org/" + json.slug + "/builds/" + json.last_build_id)
				buildIdLink.appendChild(document.createTextNode("#" + json.last_build_number))
				buildId.appendChild(buildIdLink)
				panel.appendChild(buildId)

				repoDesc = document.createElement("div")
				repoDescLink = document.createElement("a")
				repoDescLink.setAttribute("href", "https://github.com/" + json.slug)
				repoDescLinkIco = document.createElement("img")
				repoDescLinkIco.setAttribute("src", "https://github.com/favicon.ico")
				repoDescLink.appendChild(repoDescLinkIco)
				repoDescLink.appendChild(document.createTextNode(json.description))
				repoDesc.appendChild(repoDescLink)
				panel.appendChild(repoDesc)

				buildDone = document.createElement("div")
				buildDone.appendChild(document.createTextNode(humaneDate(json.last_build_finished_at)))
				panel.appendChild(buildDone)

				return panel
			}

			// update the dashboard
			function update() {

				// use myself as default user
				user = "stackmagic"

				// try to get travis username from github subdomain
				loc = window.location.hostname
				if (loc.length > 0 && loc.split(".").length > 0 && loc.indexOf("localhost") < 0 && loc.indexOf("127.0.0") < 0) {
					user = loc.split(".")[0];
					console.log("Got user from subdomain => " + user)
				}

				// try to get username from anchor in url
				loc = window.location.href
				if (user == "stackmagic" && loc.indexOf("#") > 0) {
					newUser = loc.split("#")[1]
					if (newUser.length > 0) {
						user = newUser
						console.log("Got user from hash => " + user)
					}
				}

				// cleanup old script calls
				while (document.body.getElementsByTagName("script").length > 0) {
					document.body.removeChild(document.body.getElementsByTagName("script")[0])
				}

				// call travis via jsonp
				travisUrl = "https://api.travis-ci.org/repositories.json?owner_name=" + user + "&amp;callback=parseResponse";
				console.log("CALLING: " + travisUrl);

				script = document.createElement("script")
				script.setAttribute("type", "text/javascript")
				script.setAttribute("src", travisUrl)
				document.body.appendChild(script)
			}

			function lastUpdated() {
				lu = document.getElementById("lastUpdated")
				lu.innerText = humaneDate(lu.lastUpdated)
			}

			function init() {
				update()
				setInterval(lastUpdated, 1000)
				setInterval(update, 30000)
			}
		</script>
	</head>
	<body id="body" onload="init()" onhashchange="update()">
		<div id="credit">
			<a href="javascript:update()">update now</a> (last updated: <span id="lastUpdated">never</span>) |
			<a href="https://travis-ci.org">travis-ci</a> dashboard by
			<a href="https://www.twitter.com/stackmagic">@</a><a href="https://github.com/stackmagic">stackmagic</a> |
			<a href="https://github.com/stackmagic/maven-repo#readme">README</a>
		</div>
		<div id="result">Loading...</div>
	</body>
</html>
